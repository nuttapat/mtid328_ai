<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MTID328: Interactive Workshop Guide with Gemini AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chosen Palette: Warm Neutral Academia -->
    <!-- Application Structure Plan: The SPA is structured as an interactive "learning journey" to guide students through the workshop handout. Instead of a linear document, it uses a main-scroll navigation with four key sections: 1. Overview & Pipeline, 2. AI Model Building, 3. Web App Creation, and 4. Deployment. The core content is organized into interactive tabs/accordions to break down the complex process into manageable steps, preventing user overload. This non-linear but guided structure is chosen for better engagement and comprehension for students without a coding background, making the learning process less intimidating and more exploratory than a static document. Gemini API features are added to provide contextual code explanations and generate clinical summaries, enhancing the educational value. -->
    <!-- Visualization & Content Choices: 
    - ML Pipeline: Report Info -> 5 steps of ML. Goal -> Organize/Inform. Viz -> Clickable HTML/CSS diagram. Interaction -> Click reveals description. Justification -> Visually represents the process flow. Library -> HTML/CSS/JS.
    - Code Building Steps: Report Info -> Prompts and code for each step. Goal -> Inform/Organize. Viz -> Tabbed interface. Interaction -> Clicking a tab shows content. Gemini Interaction -> "Explain Code" button calls Gemini API to generate a simplified explanation of the code snippet. Justification -> Provides on-demand, tailored learning support. Library -> HTML/CSS/JS, Gemini API.
    - Final App Preview: Report Info -> Description of the Streamlit app. Goal -> Motivate/Inform. Viz -> Interactive HTML/CSS mockup. Gemini Interaction -> Sliders for patient data input and a "Generate Clinical Summary" button that calls Gemini API to create a narrative summary from the data points. Justification -> Connects abstract data points to a real-world clinical context. Library -> HTML/CSS/JS, Gemini API. -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f3f2; /* A warm, very light gray */
            color: #44403c; /* stone-700 */
        }
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');
        
        .active-tab {
            border-color: #0d9488; /* teal-600 */
            background-color: #ccfbf1; /* teal-100 */
            color: #134e4a; /* teal-900 */
            font-weight: 600;
        }
        .code-block {
            background-color: #292524; /* stone-800 */
            color: #e2e8f0; /* slate-200 */
            padding: 1rem;
            border-radius: 0.5rem;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            word-break: break-all;
        }
        .prompt-block {
            background-color: #e7e5e4; /* stone-200 */
            border-left: 4px solid #a8a29e; /* stone-400 */
            padding: 1rem;
            border-radius: 0.25rem;
        }
        .pipeline-step {
            transition: all 0.2s ease-in-out;
        }
        .pipeline-step.active {
            background-color: #0d9488;
            color: white;
            transform: translateY(-4px);
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .nav-link {
            transition: color 0.2s;
        }
        .nav-link:hover {
            color: #0d9488;
        }
        .gemini-btn {
            background-color: #c4b5fd; /* violet-300 */
            color: #5b21b6; /* violet-800 */
            transition: background-color 0.2s;
        }
        .gemini-btn:hover {
            background-color: #a78bfa; /* violet-400 */
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #0d9488;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="antialiased">

    <!-- Header & Navigation -->
    <header class="bg-white/80 backdrop-blur-md sticky top-0 z-50 shadow-sm">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center space-x-2">
                    <span class="text-xl font-bold text-teal-700">MTID328</span>
                    <span class="hidden sm:block text-stone-500">| Interactive Guide</span>
                </div>
                <nav class="hidden md:flex space-x-6 text-sm font-medium text-stone-600">
                    <a href="#overview" class="nav-link">Overview</a>
                    <a href="#part1" class="nav-link">Part 1: The Model</a>
                    <a href="#part2" class="nav-link">Part 2: The App</a>
                    <a href="#part3" class="nav-link">Part 3: Go Live</a>
                </nav>
                <div class="md:hidden">
                    <button id="menu-btn" class="text-stone-600 focus:outline-none">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                    </button>
                </div>
            </div>
        </div>
        <!-- Mobile Menu -->
        <div id="mobile-menu" class="hidden md:hidden">
            <a href="#overview" class="block py-2 px-4 text-sm text-stone-600 hover:bg-teal-50">Overview</a>
            <a href="#part1" class="block py-2 px-4 text-sm text-stone-600 hover:bg-teal-50">Part 1: The Model</a>
            <a href="#part2" class="block py-2 px-4 text-sm text-stone-600 hover:bg-teal-50">Part 2: The App</a>
            <a href="#part3" class="block py-2 px-4 text-sm text-stone-600 hover:bg-teal-50">Part 3: Go Live</a>
        </div>
    </header>

    <main class="max-w-5xl mx-auto p-4 sm:p-6 lg:p-8">
        
        <!-- Section 0: Overview -->
        <section id="overview" class="mb-16 scroll-mt-20">
            <h1 class="text-3xl sm:text-4xl font-bold text-teal-800 text-center mb-2">Build Your First AI Web App</h1>
            <p class="text-center text-stone-600 mb-12 max-w-3xl mx-auto">Welcome! Today, you'll go from zero Python experience to building a functional web app that uses AI to predict diabetes. This guide, enhanced with âœ¨ Gemini AI, will walk you through every step.</p>

            <div class="bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-2xl font-bold text-stone-800 mb-4">The Machine Learning Pipeline</h2>
                <p class="text-stone-600 mb-6">Before we code, it's important to understand the process. A machine learning project follows a series of steps called a "pipeline". Click on each step below to learn more about it.</p>
                <div class="flex flex-col md:flex-row items-center justify-between space-y-4 md:space-y-0 md:space-x-4 mb-6">
                    <div id="step-1" class="pipeline-step cursor-pointer p-3 w-full md:w-auto flex-1 text-center bg-stone-200 rounded-lg">1. Install & Load</div>
                    <span class="text-stone-400 font-bold hidden md:block">&rarr;</span>
                    <div id="step-2" class="pipeline-step cursor-pointer p-3 w-full md:w-auto flex-1 text-center bg-stone-200 rounded-lg">2. Prepare Data</div>
                    <span class="text-stone-400 font-bold hidden md:block">&rarr;</span>
                    <div id="step-3" class="pipeline-step cursor-pointer p-3 w-full md:w-auto flex-1 text-center bg-stone-200 rounded-lg">3. Train Model</div>
                     <span class="text-stone-400 font-bold hidden md:block">&rarr;</span>
                    <div id="step-4" class="pipeline-step cursor-pointer p-3 w-full md:w-auto flex-1 text-center bg-stone-200 rounded-lg">4. Save Model</div>
                </div>
                <div id="pipeline-explanation" class="bg-teal-50 text-teal-800 p-4 rounded-lg min-h-[80px] flex items-center justify-center transition-all duration-300">
                    <p class="text-center">Click a step above to see its description here.</p>
                </div>
            </div>
        </section>

        <!-- Section 1: Building the AI Model -->
        <section id="part1" class="mb-16 scroll-mt-20">
            <h2 class="text-3xl font-bold mb-2 text-stone-800">Part 1: The Experiment - Building the AI Model</h2>
            <p class="text-stone-600 mb-8">In this part, we will use Google Colab to write the Python code that trains our AI model. We'll ask Gemini, our AI assistant, to generate the code for each step.</p>
            
            <div class="bg-white p-6 rounded-lg shadow-md">
                <div class="border-b border-stone-200 mb-4">
                    <nav class="flex flex-wrap -mb-px" id="part1-tabs">
                        <button data-target="panel-1-1" class="part1-tab active-tab text-sm font-medium text-center border-b-2 border-transparent px-4 py-3 text-stone-500 hover:text-stone-700 hover:border-stone-300">1. Install Libraries</button>
                        <button data-target="panel-1-2" class="part1-tab text-sm font-medium text-center border-b-2 border-transparent px-4 py-3 text-stone-500 hover:text-stone-700 hover:border-stone-300">2. Load Data</button>
                        <button data-target="panel-1-3" class="part1-tab text-sm font-medium text-center border-b-2 border-transparent px-4 py-3 text-stone-500 hover:text-stone-700 hover:border-stone-300">3. Prepare Data</button>
                        <button data-target="panel-1-4" class="part1-tab text-sm font-medium text-center border-b-2 border-transparent px-4 py-3 text-stone-500 hover:text-stone-700 hover:border-stone-300">4. Train Model</button>
                        <button data-target="panel-1-5" class="part1-tab text-sm font-medium text-center border-b-2 border-transparent px-4 py-3 text-stone-500 hover:text-stone-700 hover:border-stone-300">5. Save Model</button>
                    </nav>
                </div>

                <div id="panel-1-1" class="part1-panel">
                    <h3 class="text-xl font-bold text-stone-700 mb-2">Goal: Install Necessary Libraries</h3>
                    <p class="text-stone-600 mb-4">First, we need to install the tools for data handling (`pandas`) and AI (`scikit-learn`).</p>
                    <h4 class="font-semibold mb-2">Expected Python Code:</h4>
                    <div class="code-block mb-2">!pip install scikit-learn pandas</div>
                    <button class="gemini-btn text-sm font-semibold px-3 py-1 rounded-md mb-4" data-code-block="!pip install scikit-learn pandas">âœ¨ Explain This Code</button>
                </div>

                <div id="panel-1-2" class="part1-panel hidden">
                    <h3 class="text-xl font-bold text-stone-700 mb-2">Goal: Load the Dataset</h3>
                    <p class="text-stone-600 mb-4">Next, we load the Pima Indians Diabetes dataset, which contains anonymized clinical data.</p>
                    <h4 class="font-semibold mb-2">Expected Python Code:</h4>
                    <div class="code-block mb-2" id="code-load-data">import pandas as pd
url = "https://raw.githubusercontent.com/jbrownlee/Datasets/master/pima-indians-diabetes.data.csv"
names = ['preg', 'plas', 'pres', 'skin', 'test', 'mass', 'pedi', 'age', 'class']
data = pd.read_csv(url, names=names)
print(data.head())</div>
                    <button class="gemini-btn text-sm font-semibold px-3 py-1 rounded-md mb-4" data-code-block-id="code-load-data">âœ¨ Explain This Code</button>
                </div>

                <div id="panel-1-3" class="part1-panel hidden">
                    <h3 class="text-xl font-bold text-stone-700 mb-2">Goal: Separate Data into Features (X) and Target (y)</h3>
                    <p class="text-stone-600 mb-4">We split our data into two parts: `X` (the clinical measurements, or "features") and `y` (the final diagnosis, or "target").</p>
                    <h4 class="font-semibold mb-2">Expected Python Code:</h4>
                    <div class="code-block mb-2" id="code-prepare-data">X = data.drop('class', axis=1)
y = data['class']</div>
                     <button class="gemini-btn text-sm font-semibold px-3 py-1 rounded-md mb-4" data-code-block-id="code-prepare-data">âœ¨ Explain This Code</button>
                </div>
                
                <div id="panel-1-4" class="part1-panel hidden">
                    <h3 class="text-xl font-bold text-stone-700 mb-2">Goal: Train the AI Model</h3>
                    <p class="text-stone-600 mb-4">This is where the magic happens. We "teach" the AI model by showing it the feature data (`X`) and the correct outcomes (`y`).</p>
                    <h4 class="font-semibold mb-2">Expected Python Code:</h4>
                    <div class="code-block mb-2" id="code-train-model">from sklearn.model_selection import train_test_split
from sklearn.linear_model import LogisticRegression

X_train, X_test, y_train, y_test = train_test_split(X, y, test_size=0.3, random_state=42)
model = LogisticRegression(max_iter=200)
model.fit(X_train, y_train)
print("Model trained successfully!")</div>
                    <button class="gemini-btn text-sm font-semibold px-3 py-1 rounded-md mb-4" data-code-block-id="code-train-model">âœ¨ Explain This Code</button>
                </div>
                
                <div id="panel-1-5" class="part1-panel hidden">
                    <h3 class="text-xl font-bold text-stone-700 mb-2">Goal: Save Your Trained Model</h3>
                    <p class="text-stone-600 mb-4">We save our trained model to a file. This allows us to load it later into our web app without having to retrain it every time.</p>
                    <h4 class="font-semibold mb-2">Expected Python Code:</h4>
                    <div class="code-block mb-2" id="code-save-model">import pickle

filename = 'diabetes_model.pkl'
pickle.dump(model, open(filename, 'wb'))
print(f"Model saved to {filename}")</div>
                    <button class="gemini-btn text-sm font-semibold px-3 py-1 rounded-md mb-4" data-code-block-id="code-save-model">âœ¨ Explain This Code</button>
                </div>
            </div>
        </section>

        <!-- Section 2: Building the Web Application -->
        <section id="part2" class="mb-16 scroll-mt-20">
            <h2 class="text-3xl font-bold mb-2 text-stone-800">Part 2: The Clinic - Building the Web App</h2>
            <p class="text-stone-600 mb-8">Now that we have a trained AI model, we will build a user-friendly web interface for it using Streamlit. This will turn our model into a usable tool.</p>
             <div class="bg-white p-6 rounded-lg shadow-md">
                <div class="grid md:grid-cols-2 gap-8 items-center">
                    <div>
                        <h4 class="font-semibold mb-2">Expected Python Code (`app.py`):</h4>
                        <div class="code-block text-xs h-96 overflow-y-auto" id="code-app-py">import streamlit as st
import pandas as pd
import pickle

# Load the trained model
with open('diabetes_model.pkl', 'rb') as model_file:
    model = pickle.load(model_file)
    
st.title('ðŸ©º Diabetes Prediction App')
st.write("Enter patient data to predict the likelihood of diabetes.")

# Create sidebar for user input
st.sidebar.header('Patient Data')

def user_input_features():
    preg = st.sidebar.slider('Pregnancies', 0, 17, 3)
    plas = st.sidebar.slider('Plasma Glucose', 0, 200, 120)
    pres = st.sidebar.slider('Blood Pressure', 0, 122, 70)
    skin = st.sidebar.slider('Skin Thickness', 0, 99, 20)
    test = st.sidebar.slider('Insulin Test', 0, 846, 79)
    mass = st.sidebar.slider('Body Mass Index (BMI)', 0.0, 67.1, 32.0)
    pedi = st.sidebar.slider('Diabetes Pedigree Function', 0.078, 2.42, 0.3725)
    age = st.sidebar.slider('Age (years)', 21, 81, 29)
    
    data = {
        'preg': preg, 'plas': plas, 'pres': pres, 
        'skin': skin, 'test': test, 'mass': mass, 
        'pedi': pedi, 'age': age
    }
    features = pd.DataFrame(data, index=[0])
    return features
    
input_df = user_input_features()

st.subheader('Patient Input Data')
st.write(input_df)

if st.button('Predict'):
    prediction = model.predict(input_df)
    
    st.subheader('Prediction Result')
    if prediction[0] == 1:
        st.error('The patient is likely Diabetic.')
    else:
        st.success('The patient is likely Not Diabetic.')
</div>
                        <button class="gemini-btn text-sm font-semibold px-3 py-1 rounded-md mt-2" data-code-block-id="code-app-py">âœ¨ Explain This Code</button>
                    </div>
                    <div>
                        <h4 class="font-semibold mb-2">Final App Preview & Gemini Feature</h4>
                        <div id="app-preview" class="border-4 border-stone-300 rounded-lg p-2 bg-stone-100">
                             <div class="flex">
                                 <div class="w-2/5 bg-stone-50 p-4 rounded-l-md">
                                     <h5 class="font-bold mb-4">Patient Data</h5>
                                     <label class="text-xs">Pregnancies: <span id="preg-val">3</span></label>
                                     <input id="preg-slider" type="range" class="w-full h-1 bg-stone-200 rounded-lg appearance-none cursor-pointer" min="0" max="17" value="3">
                                     <label class="text-xs mt-2 block">Glucose: <span id="plas-val">120</span></label>
                                     <input id="plas-slider" type="range" class="w-full h-1 bg-stone-200 rounded-lg appearance-none cursor-pointer" min="0" max="200" value="120">
                                     <label class="text-xs mt-2 block">BMI: <span id="mass-val">32.0</span></label>
                                     <input id="mass-slider" type="range" class="w-full h-1 bg-stone-200 rounded-lg appearance-none cursor-pointer" min="0" max="67.1" value="32.0" step="0.1">
                                     <label class="text-xs mt-2 block">Age: <span id="age-val">29</span></label>
                                     <input id="age-slider" type="range" class="w-full h-1 bg-stone-200 rounded-lg appearance-none cursor-pointer" min="21" max="81" value="29">
                                 </div>
                                 <div class="w-3/5 p-4">
                                     <h3 class="text-lg font-bold">ðŸ©º Diabetes Prediction App</h3>
                                     <button class="bg-teal-600 text-white text-sm px-4 py-2 rounded-lg w-full mt-4">Predict</button>
                                     <button id="generate-summary-btn" class="gemini-btn text-sm font-semibold px-4 py-2 rounded-lg w-full mt-2">âœ¨ Generate Clinical Summary</button>
                                     <div class="mt-4">
                                         <h4 class="text-sm font-bold">Clinical Summary</h4>
                                         <div id="summary-output" class="bg-violet-50 text-violet-800 p-2 rounded-md text-xs min-h-[100px]">Adjust sliders and click generate...</div>
                                     </div>
                                 </div>
                             </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- Section 3: Going Live -->
        <section id="part3" class="scroll-mt-20">
             <h2 class="text-3xl font-bold mb-2 text-stone-800">Part 3: Go Live!</h2>
            <p class="text-stone-600 mb-8">This is the final step. We'll use the command line (or Terminal) to start our Streamlit web application.</p>
            <div class="bg-white p-6 rounded-lg shadow-md">
                <div class="grid md:grid-cols-3 gap-6">
                    <div>
                        <h3 class="text-xl font-bold text-stone-700 mb-2"><span class="text-teal-600">Step 1:</span> Open Terminal</h3>
                        <p class="text-stone-600">Open the command line on your computer. On Windows, this is `Command Prompt`. On Mac, it's `Terminal`.</p>
                    </div>
                     <div>
                        <h3 class="text-xl font-bold text-stone-700 mb-2"><span class="text-teal-600">Step 2:</span> Navigate to Folder</h3>
                        <p class="text-stone-600 mb-2">Use the `cd` command to navigate to the folder where you saved your `app.py` and `diabetes_model.pkl` files.</p>
                        <div class="code-block text-sm">cd path/to/your/folder</div>
                    </div>
                     <div>
                        <h3 class="text-xl font-bold text-stone-700 mb-2"><span class="text-teal-600">Step 3:</span> Run the App</h3>
                        <p class="text-stone-600 mb-2">First, install Streamlit if you haven't already, then run the app.</p>
                        <div class="code-block text-sm">pip install streamlit
streamlit run app.py</div>
                    </div>
                </div>
                <div class="mt-8 bg-teal-50 border-l-4 border-teal-500 text-teal-800 p-4 rounded-r-lg">
                    <p>Your web browser should automatically open a new tab with your live, interactive AI application. Congratulations, you are now an AI developer! ðŸš€</p>
                </div>
            </div>
        </section>

    </main>

    <footer class="bg-stone-800 text-stone-300 mt-16">
        <div class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8 text-center text-sm">
            <p>MTID328: Machine Learning & AI Technology for Healthcare</p>
            <p>Faculty of Medical Technology, Mahidol University</p>
        </div>
    </footer>

    <!-- Gemini Explanation Modal -->
    <div id="gemini-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[80vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-violet-800">âœ¨ Gemini Code Explanation</h3>
                    <button id="close-modal-btn" class="text-stone-500 hover:text-stone-800">&times;</button>
                </div>
                <div id="modal-content" class="text-stone-700 space-y-4">
                    <!-- Content will be injected here -->
                </div>
            </div>
        </div>
    </div>


    <script>
        // Mobile menu toggle
        const menuBtn = document.getElementById('menu-btn');
        const mobileMenu = document.getElementById('mobile-menu');
        menuBtn.addEventListener('click', () => {
            mobileMenu.classList.toggle('hidden');
        });

        // Pipeline interaction
        const pipelineSteps = {
            'step-1': '<strong>Install & Load Data:</strong> We begin by installing the necessary tools (libraries) and loading our dataset into the environment. This is like preparing your lab bench and getting your samples.',
            'step-2': '<strong>Prepare Data:</strong> Raw data is often messy. This step involves cleaning the data and getting it into the right format for the model, separating the predictive features from the outcome we want to predict.',
            'step-3': '<strong>Train Model:</strong> This is the core "learning" phase. We feed the prepared data to our AI algorithm, which learns the patterns and relationships between the features and the outcomes.',
            'step-4': '<strong>Save Model:</strong> Once the model is trained, we save its learned "knowledge" into a file. This allows us to reuse the model in other applications without retraining it from scratch.'
        };
        const pipelineContainer = document.querySelector('.flex.flex-col.md\\:flex-row');
        const explanationBox = document.getElementById('pipeline-explanation');
        
        pipelineContainer.addEventListener('click', (e) => {
            if (e.target.classList.contains('pipeline-step')) {
                const stepId = e.target.id;
                explanationBox.innerHTML = pipelineSteps[stepId];
                pipelineContainer.querySelectorAll('.pipeline-step').forEach(step => step.classList.remove('active'));
                e.target.classList.add('active');
            }
        });

        // Tab functionality for Part 1
        const part1Tabs = document.getElementById('part1-tabs');
        const part1Panels = document.querySelectorAll('.part1-panel');

        part1Tabs.addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON') {
                part1Tabs.querySelectorAll('button').forEach(tab => tab.classList.remove('active-tab'));
                e.target.classList.add('active-tab');
                const targetPanelId = e.target.dataset.target;
                part1Panels.forEach(panel => {
                    panel.id === targetPanelId ? panel.classList.remove('hidden') : panel.classList.add('hidden');
                });
            }
        });

        // Smooth scroll for nav links
        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function (e) {
                e.preventDefault();
                mobileMenu.classList.add('hidden');
                document.querySelector(this.getAttribute('href')).scrollIntoView({ behavior: 'smooth' });
            });
        });

        // --- Gemini API Integration ---

        const modal = document.getElementById('gemini-modal');
        const modalContent = document.getElementById('modal-content');
        const closeModalBtn = document.getElementById('close-modal-btn');

        // Function to call Gemini API
        async function callGemini(prompt) {
            const apiKey = ""; 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
            
            const payload = {
                contents: [{ role: "user", parts: [{ text: prompt }] }]
            };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`API call failed with status: ${response.status}`);
                }

                const result = await response.json();
                if (result.candidates && result.candidates.length > 0 && result.candidates[0].content.parts.length > 0) {
                    return result.candidates[0].content.parts[0].text;
                } else {
                    return "Sorry, I couldn't get a response. The response from the AI was empty.";
                }
            } catch (error) {
                console.error("Gemini API call error:", error);
                return `An error occurred: ${error.message}. Please check the console for details.`;
            }
        }

        // Feature 1: Explain This Code
        document.querySelectorAll('.gemini-btn[data-code-block], .gemini-btn[data-code-block-id]').forEach(button => {
            button.addEventListener('click', async () => {
                let codeText = '';
                if (button.dataset.codeBlock) {
                    codeText = button.dataset.codeBlock;
                } else if (button.dataset.codeBlockId) {
                    codeText = document.getElementById(button.dataset.codeBlockId).innerText;
                }

                if (!codeText) return;

                modalContent.innerHTML = '<div class="flex justify-center"><div class="loader"></div></div>';
                modal.classList.remove('hidden');

                const prompt = `As a friendly computer science tutor for medical students, explain this Python code snippet in simple, clear terms. Use analogies related to a clinical lab or medical studies if possible. Focus on what it does and why it's important for our diabetes prediction project. Format your response with Markdown. \n\nCode:\n\`\`\`python\n${codeText}\n\`\`\``;
                
                const explanation = await callGemini(prompt);
                // A simple markdown to HTML converter
                const formattedExplanation = explanation
                    .replace(/`([^`]+)`/g, '<code class="bg-stone-200 text-stone-800 px-1 rounded">\$1</code>')
                    .replace(/\*\*(.+?)\*\*/g, '<strong>\$1</strong>')
                    .replace(/\n/g, '<br>');

                modalContent.innerHTML = formattedExplanation;
            });
        });

        closeModalBtn.addEventListener('click', () => modal.classList.add('hidden'));
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.classList.add('hidden');
            }
        });

        // Feature 2: Generate Clinical Summary
        const appPreviewSliders = document.querySelectorAll('#app-preview input[type="range"]');
        appPreviewSliders.forEach(slider => {
            slider.addEventListener('input', (e) => {
                document.getElementById(`${e.target.id.split('-')[0]}-val`).innerText = e.target.value;
            });
        });
        
        const generateSummaryBtn = document.getElementById('generate-summary-btn');
        const summaryOutput = document.getElementById('summary-output');

        generateSummaryBtn.addEventListener('click', async () => {
            const preg = document.getElementById('preg-slider').value;
            const plas = document.getElementById('plas-slider').value;
            const mass = document.getElementById('mass-slider').value;
            const age = document.getElementById('age-slider').value;

            summaryOutput.innerHTML = '<div class="flex justify-center"><div class="loader"></div></div>';

            const prompt = `A machine learning model predicted a patient is 'Diabetic' based on this partial data: Pregnancies: ${preg}, Plasma Glucose: ${plas}, BMI: ${mass}, Age: ${age}. Write a brief, one-paragraph clinical summary a medical technologist might write for a doctor. The tone should be professional and concise. Note these key risk factors in the summary.`;
            
            const summary = await callGemini(prompt);
            summaryOutput.innerText = summary;
        });

    </script>
</body>
</html>
